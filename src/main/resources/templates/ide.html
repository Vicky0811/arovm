<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Arovm IDE | [[${username}]]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style type="text/css">
        /* --- Layout & Navbar --- */
        body { background-color: #f4f4f4; height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-family: 'Segoe UI', Tahoma, sans-serif; }
        #navbar { height: 70px; background: #2c3e50; color: white; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }

        .brand-logo { height: 40px; width: auto; margin-right: 15px; vertical-align: middle; }
        .product { font-weight: bold; font-size: 1.2rem; margin-right: 20px; color: white; text-decoration: none; }

        .lang-select { background: #34495e; color: white; border: 1px solid #4e6075; padding: 5px; border-radius: 4px; width: 160px; }
        .btn-custom { color: white !important; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-custom:hover { opacity: 0.8; }

        /* --- Workspace Layout --- */
        .ide-container { display: flex; flex: 1; height: calc(100vh - 100px); position: relative; }
        #editor { width: 50%; height: 100%; font-size: 16px; transition: width 0.3s ease; }

        .output-container { width: 50%; background: #1e1e1e; color: #00ff00; display: flex; flex-direction: column; border-left: 2px solid #444; transition: width 0.3s ease; overflow: hidden; }
        .output-header { padding: 8px 15px; background: #333; color: #ccc; font-size: 0.9rem; font-weight: bold; border-bottom: 1px solid #555; display: flex; justify-content: space-between; align-items: center; }
        .output-content { flex: 1; padding: 15px; overflow-y: auto; font-family: 'Consolas', 'Monaco', monospace; }

        #footer-status { height: 30px; background: #34495e; color: #bdc3c7; font-size: 0.8rem; display: flex; align-items: center; padding: 0 20px; border-top: 1px solid #2c3e50; }

        .user-info { display: flex; align-items: center; gap: 10px; padding-left: 15px; border-left: 1px solid #4e6075; }
    </style>
</head>
<body>

<div id="navbar">
    <div class="d-flex align-items-center">
        <a href="/" class="brand-wrapper">
            <img src="/images/logo.png" alt="Arovm" class="brand-logo">
        </a>
        <span class="product">IDE</span>
        <select id="languageSelector" class="lang-select form-select form-select-sm" onchange="changeLanguage()">
            <option value="" disabled selected>-- Select Language --</option>
            <option value="java">Java 21</option>
            <option value="python">Python 3</option>
            <option value="c_cpp">C / C++</option>
            <option value="html">Web (HTML/CSS/JS)</option>
        </select>
    </div>

    <div class="d-flex align-items-center gap-2">
        <button class="btn btn-custom btn-success btn-sm" onclick="runCode()"><i class="fas fa-play"></i> Run</button>
        <button class="btn btn-custom btn-danger btn-sm" onclick="stopCode()"><i class="fas fa-stop"></i> Stop</button>
        <button class="btn btn-custom btn-primary btn-sm" onclick="saveProject()"><i class="fas fa-save"></i> Save</button>
        <button class="btn btn-custom btn-info btn-sm text-white" onclick="openMyProjects()"><i class="fas fa-folder-open"></i> My Projects</button>
        <button class="btn btn-custom btn-secondary btn-sm" onclick="downloadCode()"><i class="fas fa-download"></i></button>
        <button class="btn btn-custom btn-dark btn-sm" onclick="toggleTerminal()"><i class="fas fa-terminal"></i></button>

        <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span th:text="${username}">Guest_User</span>
            <input type="hidden" id="hiddenProfileId" th:value="${profileId != null ? profileId : 'guest_arovm'}">
        </div>
    </div>
</div>

<div class="ide-container">
    <div id="editor">// Select a language to start your Arovm project...</div>
    <div class="output-container" id="outputPanel">
        <div class="output-header">
            <span>TERMINAL</span>
            <button class="btn btn-sm text-white" onclick="toggleTerminal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="output-content">
            <pre id="outputText" style="margin: 0;">System Ready.</pre>
            <iframe id="webPreview" style="width:100%; height:100%; display:none; border:none; background:white;"></iframe>
        </div>
    </div>
</div>

<div id="footer-status">
    <span id="statusText">Status: Idle</span>
    <span class="ms-auto">Java 21 Environment | Docker Sandbox Active</span>
</div>

<div class="modal fade" id="projectsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Project Explorer: <span id="modalProfileName" class="text-info">[[${username}]]</span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-dark table-hover">
                    <thead>
                    <tr class="text-muted">
                        <th>Name</th><th>Language</th><th>Created</th><th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="projectListBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/text");
    editor.setFontSize(16);
    var projectModal = new bootstrap.Modal(document.getElementById('projectsModal'));

    const CURRENT_PROFILE_ID = document.getElementById('hiddenProfileId').value;

    const snippets = {
        "java": 'public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello Arovm Java 21!");\n    }\n}',
        "python": 'print("Hello Arovm Python!")',
        "c_cpp": '#include <iostream>\nusing namespace std;\n\nint main() {\n    cout << "Hello Arovm C++!";\n    return 0;\n}',
        "html": '<html>\n<body style="background:#fff; color:#000; padding:20px;">\n  <h1>Hello Arovm Web!</h1>\n  <p>Start building your profile components here.</p>\n</body>\n</html>'
    };

    function changeLanguage() {
        var lang = document.getElementById("languageSelector").value;
        var mode = (lang === "c_cpp") ? "c_cpp" : lang;
        editor.session.setMode("ace/mode/" + mode);
        if(snippets[lang]) editor.setValue(snippets[lang]);
        updateStatus("Language changed to " + lang);
    }

    let terminalSocket = null; // Global variable to track the current connection

    function runCode() {
        var lang = document.getElementById("languageSelector").value;
        if(!lang) { alert("Please select a language first!"); return; }

        updateStatus("Preparing Execution...");
        toggleTerminal(true);
        var outputText = document.getElementById("outputText");
        var webPreview = document.getElementById("webPreview");

        // 1. Handle Web Preview (No changes needed here)
        if (lang === "html") {
            outputText.style.display = "none";
            webPreview.style.display = "block";
            var doc = webPreview.contentWindow.document;
            doc.open(); doc.write(editor.getValue()); doc.close();
            updateStatus("Web Preview Updated.");
        }
        // 2. Handle Docker Languages via WebSocket Streaming
        else {
            webPreview.style.display = "none";
            outputText.style.display = "block";
            outputText.innerText = "Connecting to Arovm Terminal...\n";

            // Close any existing socket before opening a new one
            if (terminalSocket) {
                terminalSocket.close();
            }

            // Establish WebSocket connection to the backend
            const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
            terminalSocket = new WebSocket(protocol + window.location.host + "/terminal");

            terminalSocket.onopen = function() {
                updateStatus("Running (Streaming)...");
                // Send both code and language as a JSON string
                terminalSocket.send(JSON.stringify({
                    code: editor.getValue(),
                    language: lang
                }));
            };

            terminalSocket.onmessage = function(event) {
                // Append the stream line-by-line as it arrives
                outputText.innerText += event.data;

                // Auto-scroll the terminal so you see the infinite loop output
                const container = document.querySelector(".output-content");
                container.scrollTop = container.scrollHeight;
            };

            terminalSocket.onerror = function(err) {
                outputText.innerText += "\n[Streaming Error: Check if backend is running]";
                updateStatus("Error encountered.");
            };

            terminalSocket.onclose = function() {
                updateStatus("Execution Finished.");
                console.log("Terminal connection closed.");
            };
        }
    }

    function saveProject() {
        var name = prompt("Enter Project Name:");
        if(!name) return;

        updateStatus("Saving to RDS...");

        // CAPTURE THE LATEST CODE HERE
        const currentCode = editor.getValue();
        const currentLang = document.getElementById("languageSelector").value;

        fetch('/api/projects/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                code: currentCode, // Use the variable we just captured
                language: currentLang,
                profileId: CURRENT_PROFILE_ID
            })
        })
            .then(r => r.text())
            .then(msg => {
                alert(msg);
                updateStatus("Project saved successfully.");
            });
    }


    function openMyProjects() {
        updateStatus("Fetching projects for " + CURRENT_PROFILE_ID);
        fetch(`/api/projects/my-projects/${CURRENT_PROFILE_ID}`)
            .then(r => r.json())
            .then(projects => {
                const body = document.getElementById('projectListBody');
                if(projects.length === 0) {
                    body.innerHTML = '<tr><td colspan="4" class="text-center">No projects found for this profile.</td></tr>';
                } else {
                    body.innerHTML = projects.map(p => `
                        <tr>
                            <td>${p.name}</td>
                            <td><span class="badge bg-primary">${p.language}</span></td>
                            <td>${new Date(p.createdAt).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="loadProject('${btoa(p.code)}', '${p.language}')">Open</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProject(${p.id})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`).join('');
                }
                projectModal.show();
                updateStatus("Project list loaded.");
            });
    }

    function loadProject(encodedCode, lang) {
        editor.setValue(atob(encodedCode));
        document.getElementById("languageSelector").value = lang;
        changeLanguage();
        projectModal.hide();
        updateStatus("Project loaded into editor.");
    }

    function deleteProject(id) {
        if(confirm("Permanently delete this project?")) {
            fetch(`/api/projects/delete/${id}`, { method: 'DELETE' })
                .then(() => openMyProjects());
        }
    }

    function stopCode() {
        if (terminalSocket) {
            terminalSocket.close(); // Stop the frontend stream
        }
        fetch('/api/stop', { method: 'POST' }) // Kill the Docker container on backend
            .then(() => {
                document.getElementById("outputText").innerText += "\n[Process Forcefully Stopped]";
                updateStatus("Stopped.");
            });
    }

    function downloadCode() {
        const blob = new Blob([editor.getValue()], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "Arovm_" + document.getElementById("languageSelector").value + ".txt";
        a.click();
    }

    function toggleTerminal(forceOpen = false) {
        var panel = document.getElementById("outputPanel");
        var ed = document.getElementById("editor");
        if (forceOpen || panel.style.width === "0%") { panel.style.width = "50%"; ed.style.width = "50%"; }
        else { panel.style.width = "0%"; ed.style.width = "100%"; }
        setTimeout(() => editor.resize(), 310);
    }

    function updateStatus(msg) { document.getElementById("statusText").innerText = "Status: " + msg; }
</script>
</body>
</html>